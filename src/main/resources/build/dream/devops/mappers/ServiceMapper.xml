<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="build.dream.devops.mappers.ServiceMapper">
    <select id="listServiceNodes" resultType="build.dream.common.utils.UnderscoreToCamelCaseMap">
        SELECT
        service_node.id AS service_node_id,
        service_node.status,
        service_node.pid,
        host.name,
        host.ip_address
        FROM service_node
        INNER JOIN host ON host.id = service_node.host_id AND host.deleted = 0
        WHERE service_node.deleted = 0
        AND service_node.service_id = #{serviceId}
    </select>

    <select id="findAllServiceNodes" resultType="build.dream.common.utils.UnderscoreToCamelCaseMap">
        SELECT
        service_node.id AS service_node_id,
        service_node.status,
        service_node.pid,
        service.port,
        service.health_check_path,
        host.ip_address,
        host.user_name,
        host.password,
        host.ssh_port
        FROM service_node
        INNER JOIN service ON service.id = service_node.service_id AND service.deleted = 0
        INNER JOIN host ON host.id = service_node.host_id AND host.deleted = 0
        WHERE service_node.deleted = 0
        AND service_node.pid != ''
    </select>

    <delete id="deleteJavaOptions">
        DELETE FROM java_option WHERE service_id = #{serviceId}
    </delete>

    <update id="updateServiceNodeStatus">
        UPDATE
        service_node
        SET status = #{status}
        WHERE id = #{id}
    </update>

    <update id="updateServiceNodePid">
        UPDATE
        service_node
        SET pid = #{pid}
        WHERE id = #{id}
    </update>
</mapper>